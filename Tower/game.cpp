#include "game.h"
#include "drawingOperation.hpp"
#include "drawImage.hpp"

#include <unistd.h>
#include <stdlib.h>
#include <stdio.h>

const unsigned FRAME_FLOAT = 0xFF;

//Will cause crashes on exit. Just a test.
void TowerHelloWorld(void){

    unsigned char testPixels[] = {
    0xFF,0x0, 0x0, 0xFF,/**/0xFF,0x0, 0x0, 0xFF,/**/0x0, 0xFF,0x0, 0xFF,/**/0x0, 0xFF,0x0, 0xFF,/**/0xFF,0xFF,0x0, 0xFF,/**/0xFF,0xFF,0x0, 0xFF,
    0xFF,0x0, 0x0, 0xFF,/**/0xFF,0x0, 0x0, 0xFF,/**/0x0, 0xFF,0x0, 0xFF,/**/0x0, 0xFF,0x0, 0xFF,/**/0xFF,0xFF,0x0, 0xFF,/**/0xFF,0xFF,0x0, 0xFF,
    0xFF,0x0, 0x0, 0xFF,/**/0xFF,0x0, 0x0, 0xFF,/**/0x0, 0xFF,0x0, 0xFF,/**/0x0, 0xFF,0x0, 0xFF,/**/0xFF,0xFF,0x0, 0xFF,/**/0xFF,0xFF,0x0, 0xFF,
    0xFF,0xFF,0xFF,0xFF,/**/0x0, 0x0, 0x0, 0xFF,/**/0xFF,0xFF,0xFF,0xFF,/**/0x0, 0x0, 0x0, 0xFF,/**/0xFF,0xFF,0xFF,0xFF,/**/0x0, 0x0, 0x0, 0xFF,
    0x0, 0x0, 0xFF,0xFF,/**/0x0, 0x0, 0xFF,0xFF,/**/0xFF,0x80,0x0, 0xFF,/**/0xFF,0x80,0x0, 0xFF,/**/0x80,0x80,0x80,0xFF,/**/0x80,0x80,0x80,0xFF,
    };

    tower::gfx::Image *testPattern = new tower::gfx::Image(0, 0, 6, 5, (unsigned *)(testPixels));
    
    tower::Location *aLoc = new tower::Location(0, 0);
    
    while(true){
        printf("Pushing a frame.\n");
        bool first = true;
        while(TowerGetNumberOfFinishedFrames() > FRAME_FLOAT){
            if(first){
                first = false;
                printf("Waiting for the CV link to consume.\n");
            }
            TowerViewSignalRedraw();
            usleep(10000);
        }
    
        //TowerPushDrawQueue(new tower::gfx::ColorScreen(arc4random()));
        TowerPushDrawQueue(new tower::gfx::drawImage(testPattern, aLoc, 0, 0));
        TowerPushDrawQueue(new tower::gfx::drawImage(testPattern, aLoc, 0, 0));
        TowerPushDrawQueue(new tower::gfx::drawImage(testPattern, aLoc, 0, 0));
        TowerPushDrawQueue(new tower::gfx::drawImage(testPattern, aLoc, 0, 0));
        TowerPushDrawQueue(new tower::gfx::FlipScreen());
    
            usleep(1000);
            
    }
}